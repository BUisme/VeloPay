<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ‚Äì Loan Payment System</title>
  <link rel="stylesheet" href="css/main.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/index.js"></script>
  <style>
    .preview-box {
      background: #f0f9ff; border: 1px solid #bae6fd;
      border-radius: 12px; padding: 20px 22px; margin-top: 20px;
    }
    .preview-box h4 { color: var(--primary); margin-bottom: 12px; font-size: 15px; }
    .preview-row {
      display: flex; justify-content: space-between;
      padding: 6px 0; border-bottom: 1px solid #e0f2fe; font-size: 14px;
    }
    .preview-row:last-child { border-bottom: none; }
    .preview-row .label { color: var(--gray-600); }
    .preview-row .value { font-weight: 600; color: var(--gray-800); }
    .preview-row.highlight { background: rgba(30,58,138,0.06); margin: 0 -22px; padding: 8px 22px; border-radius: 6px; }

    .schedule-mini { max-height: 220px; overflow-y: auto; margin-top: 14px; border-radius: 8px; overflow: hidden; }
    .schedule-mini table { font-size: 12.5px; }
    .schedule-mini th { padding: 8px 10px; font-size: 11.5px; }
    .schedule-mini td { padding: 6px 10px; }
  </style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon">üí∞</div>
    <div><div class="logo-text">LoanPay</div><div class="logo-sub">‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</div></div>
  </div>
  <nav class="sidebar-nav">
    <a href="index.html"><span class="nav-icon">üìä</span><span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</span></a>
    <a href="loan-form.html" class="active"><span class="nav-icon">üìù</span><span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏´‡∏°‡πà</span></a>
    <a href="loan-list.html"><span class="nav-icon">üìã</span><span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤</span></a>
  </nav>
</aside>

<!-- Main -->
<main class="main-content">

  <div class="topbar">
    <div>
      <h1>üìù ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏´‡∏°‡πà</h1>
      <div class="topbar-subtitle">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏Å‡∏π‡πâ‡πÅ‡∏•‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ</div>
    </div>
    <a href="index.html" class="btn btn-outline btn-sm">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</a>
  </div>

  <div style="display:grid; grid-template-columns:1.2fr 0.8fr; gap:24px; align-items:start;">

    <!-- Left: Form -->
    <div class="card">
      <div class="card-header"><h3>üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤</h3></div>
      <div class="card-body">

        <div class="form-grid">
          <div class="form-group">
            <label>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Å‡∏π‡πâ <span class="required">*</span></label>
            <input type="text" id="customerName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡∏™‡∏°‡∏¥‡∏ó‡∏ò‡∏¥‡πå" oninput="updatePreview()"/>
          </div>
          <div class="form-group">
            <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
            <input type="tel" id="customerPhone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 081-234-5678"/>
          </div>
          <div class="form-group">
            <label>‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</label>
            <input type="text" id="customerIdCard" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1-234-56789-0"/>
          </div>
          <div class="form-group">
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ (‡∏ö‡∏≤‡∏ó) <span class="required">*</span></label>
            <input type="number" id="loanAmount" placeholder="‡πÄ‡∏ä‡πà‡∏ô 100000" oninput="updatePreview()"/>
          </div>
          <div class="form-group">
            <label>‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ (% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ) <span class="required">*</span></label>
            <input type="number" id="interestRate" step="0.1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12" oninput="updatePreview()"/>
          </div>
          <div class="form-group">
            <label>‡πÅ‡∏ö‡∏ö‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢ <span class="required">*</span></label>
            <select id="interestType" onchange="updatePreview()">
              <option value="reducing">‡∏•‡∏î‡∏ï‡πâ‡∏ô‡∏•‡∏î‡∏î‡∏≠‡∏Å (Reducing)</option>
              <option value="flat">‡∏Ñ‡∏á‡∏ó‡∏µ‡πà (Flat Rate)</option>
            </select>
          </div>
          <div class="form-group">
            <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î <span class="required">*</span></label>
            <input type="number" id="installments" placeholder="‡πÄ‡∏ä‡πà‡∏ô 12" oninput="updatePreview()"/>
          </div>
          <div class="form-group">
            <label>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢</label>
            <select id="paymentFrequency" onchange="updatePreview()">
              <option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
              <option value="weekly">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</option>
              <option value="daily">‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô</option>
            </select>
          </div>
          <div class="form-group" style="grid-column:1/-1;">
            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤ <span class="required">*</span></label>
            <input type="date" id="startDate" oninput="updatePreview()"/>
          </div>
        </div>

        <div class="form-actions">
          <a href="index.html" class="btn btn-outline">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</a>
          <button class="btn btn-primary btn-lg" onclick="submitLoan()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤</button>
        </div>

      </div>
    </div>

    <!-- Right: Preview -->
    <div class="card" style="position:sticky;top:24px;">
      <div class="card-header"><h3>üëÅÔ∏è Preview</h3></div>
      <div class="card-body">

        <div class="preview-box">
          <h4>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</h4>
          <div class="preview-row"><span class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Å‡∏π‡πâ</span><span class="value" id="prevName">‚Äì</span></div>
          <div class="preview-row"><span class="label">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</span><span class="value" id="prevPrincipal">‚Äì</span></div>
          <div class="preview-row"><span class="label">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</span><span class="value" id="prevRate">‚Äì</span></div>
          <div class="preview-row"><span class="label">‡πÅ‡∏ö‡∏ö‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</span><span class="value" id="prevType">‚Äì</span></div>
          <div class="preview-row"><span class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î</span><span class="value" id="prevInstallments">‚Äì</span></div>
          <div class="preview-row highlight">
            <span class="label">‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡∏á‡∏ß‡∏î</span>
            <span class="value" style="color:var(--primary);" id="prevPayment">‚Äì</span>
          </div>
          <div class="preview-row"><span class="label">‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏£‡∏ß‡∏°</span><span class="value" id="prevInterest">‚Äì</span></div>
          <div class="preview-row highlight">
            <span class="label">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span>
            <span class="value" style="color:var(--success);" id="prevTotal">‚Äì</span>
          </div>
        </div>

        <!-- Mini Schedule -->
        <div class="schedule-mini" id="scheduleMini" style="display:none;">
          <table>
            <thead><tr><th>‡∏á‡∏ß‡∏î</th><th>‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</th><th>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</th><th>‡∏à‡πà‡∏≤‡∏¢</th></tr></thead>
            <tbody id="scheduleMiniBody"></tbody>
          </table>
        </div>

      </div>
    </div>

  </div>
</main>

<!-- Scripts -->
<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/calculator.js"></script>
<script src="js/database.js"></script>
<script>
// Default ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤ = ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
document.getElementById('startDate').valueAsDate = new Date();

// --- Update Preview ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà input ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ---
function updatePreview() {
  const name        = document.getElementById('customerName').value;
  const amount      = parseFloat(document.getElementById('loanAmount').value) || 0;
  const rate        = parseFloat(document.getElementById('interestRate').value) || 0;
  const type        = document.getElementById('interestType').value;
  const installments = parseInt(document.getElementById('installments').value) || 0;
  const frequency   = document.getElementById('paymentFrequency').value;

  document.getElementById('prevName').textContent         = name || '‚Äì';
  document.getElementById('prevPrincipal').textContent    = amount ? Utils.formatCurrency(amount) : '‚Äì';
  document.getElementById('prevRate').textContent         = rate ? `${rate}% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ` : '‚Äì';
  document.getElementById('prevType').textContent         = Utils.formatInterestType(type);
  document.getElementById('prevInstallments').textContent = installments ? `${installments} ‡∏á‡∏ß‡∏î (${Utils.formatFrequency(frequency)})` : '‚Äì';

  if (amount > 0 && rate > 0 && installments > 0) {
    const result = LoanCalculator.calculate(amount, rate, installments, type, frequency);
    document.getElementById('prevPayment').textContent  = Utils.formatCurrency(result.periodicPayment);
    document.getElementById('prevInterest').textContent = Utils.formatCurrency(result.totalInterest);
    document.getElementById('prevTotal').textContent    = Utils.formatCurrency(result.totalAmount);

    // Mini schedule (5 ‡∏á‡∏ß‡∏î‡πÅ‡∏£‡∏Å)
    const miniEl = document.getElementById('scheduleMini');
    miniEl.style.display = 'block';
    document.getElementById('scheduleMiniBody').innerHTML =
      result.schedule.slice(0, 5).map(r => `
        <tr>
          <td>${r.installment}</td>
          <td>${Utils.formatCurrency(r.principalAmount)}</td>
          <td>${Utils.formatCurrency(r.interestAmount)}</td>
          <td>${Utils.formatCurrency(r.totalPayment)}</td>
        </tr>
      `).join('') +
      `<tr><td colspan="4" style="text-align:center;color:#94a3b8;font-size:11px;">... ‡∏£‡∏ß‡∏° ${installments} ‡∏á‡∏ß‡∏î</td></tr>`;
  } else {
    document.getElementById('prevPayment').textContent  = '‚Äì';
    document.getElementById('prevInterest').textContent = '‚Äì';
    document.getElementById('prevTotal').textContent    = '‚Äì';
    document.getElementById('scheduleMini').style.display = 'none';
  }
}

// --- Submit (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤) ---
async function submitLoan() {
  const name        = document.getElementById('customerName').value.trim();
  const phone       = document.getElementById('customerPhone').value.trim();
  const idCard      = document.getElementById('customerIdCard').value.trim();
  const amount      = parseFloat(document.getElementById('loanAmount').value);
  const rate        = parseFloat(document.getElementById('interestRate').value);
  const type        = document.getElementById('interestType').value;
  const installments = parseInt(document.getElementById('installments').value);
  const frequency   = document.getElementById('paymentFrequency').value;
  const startDate   = document.getElementById('startDate').value;

  if (!name || !amount || !rate || !installments || !startDate) {
    Utils.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', 'error');
    return;
  }

  const calc            = LoanCalculator.calculate(amount, rate, installments, type, frequency);
  const contractNumber  = Utils.generateContractNumber();
  const qrUrl           = Utils.getCustomerViewUrl(contractNumber);

  const loanData = {
    contract_number:   contractNumber,
    customer_name:     name,
    customer_phone:    phone,
    customer_id_card:  idCard,
    loan_amount:       amount,
    interest_rate:     rate,
    interest_type:     type,
    installments,
    payment_frequency: frequency,
    start_date:        startDate,
    total_amount:      calc.totalAmount,
    monthly_payment:   calc.periodicPayment,
    status:            'active',
    qr_code_url:       qrUrl
  };

  try {
    const loan = await DB.createLoan(loanData);
    Utils.showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏•‡∏Ç: ' + contractNumber, 'success');

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Payment Schedule
    const dueDates     = LoanCalculator.generateDueDates(startDate, installments, frequency);
    const paymentsData = calc.schedule.map((row, i) => ({
      loan_id:            loan.id,
      installment_number: row.installment,
      due_date:           dueDates[i],
      principal_amount:   row.principalAmount,
      interest_amount:    row.interestAmount,
      total_amount:       row.totalPayment,
      paid_amount:        0,
      status:             'pending'
    }));

    await DB.createPaymentsSchedule(paymentsData);

    // Redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ detail
    setTimeout(() => { window.location.href = `loan-detail.html?id=${loan.id}`; }, 1500);

  } catch (err) {
    console.error('Create loan error:', err);
    Utils.showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + err.message, 'error');
  }
}
</script>

</body>
</html>
