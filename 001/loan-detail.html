<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ‚Äì Loan Payment System</title>
  <link rel="stylesheet" href="css/main.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.1/dist/jspdf.autotable.min.js"></script>
  <style>
    .detail-grid { display: grid; grid-template-columns: 1.4fr 0.6fr; gap: 22px; align-items: start; }
    .info-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--gray-200); font-size:14px; }
    .info-row:last-child { border-bottom:none; }
    .info-row .label { color:var(--gray-500); }
    .info-row .value { font-weight:600; color:var(--gray-800); text-align:right; }

    .qr-section { text-align:center; }
    .qr-section #qrContainer { display:inline-block; margin:12px 0; }
    .qr-actions { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:10px; }

    .pdf-actions { display:flex; flex-direction:column; gap:10px; }

    /* Modal */
    .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9000; justify-content:center; align-items:center; }
    .modal-overlay.show { display:flex; }
    .modal-box { background:#fff; border-radius:16px; padding:28px; width:90%; max-width:460px; box-shadow:0 12px 40px rgba(0,0,0,0.3); }
    .modal-box h3 { margin:0 0 18px; font-size:18px; color:var(--gray-800); }
    .modal-box .form-group { margin-bottom:14px; }
    .modal-actions { display:flex; gap:10px; justify-content:flex-end; margin-top:20px; }

    @media (max-width: 768px) {
      .detail-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon">üí∞</div>
    <div><div class="logo-text">LoanPay</div><div class="logo-sub">‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</div></div>
  </div>
  <nav class="sidebar-nav">
    <a href="index.html"><span class="nav-icon">üìä</span><span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</span></a>
    <a href="loan-form.html"><span class="nav-icon">üìù</span><span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏´‡∏°‡πà</span></a>
    <a href="loan-list.html"><span class="nav-icon">üìã</span><span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤</span></a>
  </nav>
</aside>

<!-- Main -->
<main class="main-content">

  <div class="topbar">
    <div>
      <h1 id="pageTitle">üìÑ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤</h1>
      <div class="topbar-subtitle" id="pageSubtitle">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div>
    </div>
    <a href="loan-list.html" class="btn btn-outline btn-sm">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</a>
  </div>

  <div class="detail-grid" id="detailGrid">
    <div class="card"><div class="card-body" style="text-align:center;padding:60px;color:#94a3b8;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</div></div>
  </div>

</main>

<!-- ========== Modal: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞ ========== -->
<div class="modal-overlay" id="payModal">
  <div class="modal-box">
    <h3>üí≥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞ ‚Äì ‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà <span id="modalInstallment">?</span></h3>
    <input type="hidden" id="modalPaymentId"/>
    <div class="form-group">
      <label>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏à‡πà‡∏≤‡∏¢</label>
      <input type="text" id="modalDueAmount" readonly style="background:var(--gray-100);font-weight:700;color:var(--primary);"/>
    </div>
    <div class="form-group">
      <label>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á (‡∏ö‡∏≤‡∏ó) <span class="required">*</span></label>
      <input type="number" id="modalPaidAmount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô"/>
    </div>
    <div class="form-group">
      <label>‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞</label>
      <select id="modalPayMethod">
        <option value="cash">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
        <option value="transfer">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option>
        <option value="check">‡πÄ‡∏ä‡πá‡∏Ñ</option>
      </select>
    </div>
    <div class="form-group">
      <label>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)</label>
      <input type="text" id="modalReceiptNumber" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à"/>
    </div>
    <div class="form-group">
      <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
      <input type="text" id="modalNotes" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"/>
    </div>
    <div class="modal-actions">
      <button class="btn btn-outline" onclick="closePayModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-success" onclick="confirmPayment()">üí≥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</button>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/calculator.js"></script>
<script src="js/database.js"></script>
<script src="js/pdf-generator.js"></script>
<script src="js/qrcode-generator.js"></script>
<script>
let currentLoan    = null;
let currentPayments = [];
let currentSummary  = null;

(async () => {
  const params = new URLSearchParams(window.location.search);
  const loanId = params.get('id');
  if (!loanId) { window.location.href = 'loan-list.html'; return; }
  await loadLoanDetail(loanId);
})();

// --- Load Loan + Payments ---
async function loadLoanDetail(loanId) {
  try {
    currentLoan     = await DB.getLoanById(loanId);
    currentPayments = await DB.getPaymentsByLoanId(loanId);
    currentSummary  = await DB.getPaymentSummary(loanId);

    document.getElementById('pageTitle').textContent    = `üìÑ ‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ${currentLoan.contract_number}`;
    document.getElementById('pageSubtitle').textContent = `‡∏ú‡∏π‡πâ‡∏Å‡∏π‡πâ: ${currentLoan.customer_name}`;

    renderDetailPage();
  } catch (err) {
    console.error(err);
    Utils.showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
  }
}

// --- Render ---
function renderDetailPage() {
  const loan    = currentLoan;
  const summary = currentSummary;
  const status  = Utils.formatStatus(loan.status);

  document.getElementById('detailGrid').innerHTML = `
    <!-- Left Column -->
    <div>
      <!-- Loan Info -->
      <div class="card" style="margin-bottom:22px;">
        <div class="card-header" style="justify-content:space-between;">
          <h3>üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤</h3>
          <span class="badge" style="color:${status.color};background:${status.bg};font-size:13px;">${status.label}</span>
        </div>
        <div class="card-body">
          <div class="info-row"><span class="label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤</span><span class="value" style="color:var(--primary);">${loan.contract_number}</span></div>
          <div class="info-row"><span class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Å‡∏π‡πâ</span><span class="value">${loan.customer_name}</span></div>
          <div class="info-row"><span class="label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</span><span class="value">${loan.customer_phone || '‚Äì'}</span></div>
          <div class="info-row"><span class="label">‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô</span><span class="value">${loan.customer_id_card || '‚Äì'}</span></div>
          <div class="info-row"><span class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ</span><span class="value">${Utils.formatCurrency(loan.loan_amount)}</span></div>
          <div class="info-row"><span class="label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</span><span class="value">${loan.interest_rate}% ‡∏ï‡πà‡∏≠‡∏õ‡∏µ</span></div>
          <div class="info-row"><span class="label">‡πÅ‡∏ö‡∏ö‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</span><span class="value">${Utils.formatInterestType(loan.interest_type)}</span></div>
          <div class="info-row"><span class="label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î</span><span class="value">${loan.installments} ‡∏á‡∏ß‡∏î (${Utils.formatFrequency(loan.payment_frequency)})</span></div>
          <div class="info-row"><span class="label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤</span><span class="value">${Utils.formatDate(loan.start_date)}</span></div>
          <div class="info-row"><span class="label">‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡∏á‡∏ß‡∏î</span><span class="value" style="color:var(--primary);font-size:16px;">${Utils.formatCurrency(loan.monthly_payment)}</span></div>
          <div class="info-row"><span class="label">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏ï‡πâ‡∏ô+‡∏î‡∏≠‡∏Å)</span><span class="value" style="color:var(--success);">${Utils.formatCurrency(loan.total_amount)}</span></div>
        </div>
      </div>

      <!-- Progress -->
      <div class="card" style="margin-bottom:22px;">
        <div class="card-header"><h3>üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</h3></div>
        <div class="card-body">
          <div style="margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;font-size:13px;color:var(--gray-600);margin-bottom:6px;">
              <span>‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ${summary.paidCount} / ${summary.totalInstallments} ‡∏á‡∏ß‡∏î</span>
              <span style="font-weight:700;color:var(--primary);">${summary.progressPercent}%</span>
            </div>
            <div class="progress-wrap"><div class="progress-bar" style="width:${summary.progressPercent}%;"></div></div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:16px;">
            <div style="background:var(--success-bg);border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:11px;color:var(--success);">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>
              <div style="font-size:16px;font-weight:700;color:var(--success);">${Utils.formatCurrency(summary.totalPaid)}</div>
            </div>
            <div style="background:var(--primary-100);border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:11px;color:var(--primary);">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
              <div style="font-size:16px;font-weight:700;color:var(--primary);">${Utils.formatCurrency(summary.remainingAmount)}</div>
            </div>
            <div style="background:var(--danger-bg);border-radius:10px;padding:12px;text-align:center;">
              <div style="font-size:11px;color:var(--danger);">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>
              <div style="font-size:16px;font-weight:700;color:var(--danger);">${summary.overdueCount} ‡∏á‡∏ß‡∏î</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment Schedule Table -->
      <div class="card">
        <div class="card-header"><h3>üí≥ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</h3></div>
        <div class="card-body" style="padding:0;">
          <div class="table-wrap">
            <table>
              <thead>
                <tr><th>‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà</th><th>‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</th><th>‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</th><th>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏à‡πà‡∏≤‡∏¢</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th><th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th></tr>
              </thead>
              <tbody id="paymentTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column -->
    <div>
      <!-- QR Code -->
      <div class="card qr-section" style="margin-bottom:22px;">
        <div class="card-header"><h3>üì± QR Code</h3></div>
        <div class="card-body">
          <p style="font-size:13px;color:var(--gray-500);margin-bottom:10px;">‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</p>
          <div id="qrContainer"></div>
          <div class="qr-actions">
            <button class="btn btn-outline btn-sm" onclick="QRCodeGenerator.downloadQR('${loan.contract_number}')">üì• Download</button>
            <button class="btn btn-outline btn-sm" onclick="QRCodeGenerator.copyQRUrl('${loan.contract_number}')">üìã Copy URL</button>
          </div>
        </div>
      </div>

      <!-- PDF -->
      <div class="card">
        <div class="card-header"><h3>üìÑ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF</h3></div>
        <div class="card-body">
          <div class="pdf-actions">
            <button class="btn btn-primary btn-sm" onclick="downloadSchedulePDF()">üìë ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡πà‡∏≠‡∏ô PDF</button>
            <button class="btn btn-outline btn-sm" onclick="downloadSummaryPDF()">üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ä‡∏≥‡∏£‡∏∞ PDF</button>
          </div>
        </div>
      </div>
    </div>
  `;

  renderPaymentRows();
  QRCodeGenerator.generate(loan.contract_number, 'qrContainer', 180);
}

// --- Render Payment Rows ---
function renderPaymentRows() {
  const tbody = document.getElementById('paymentTableBody');
  tbody.innerHTML = currentPayments.map(p => {
    const st    = Utils.formatStatus(p.status);
    const canPay = (p.status === 'pending' || p.status === 'overdue');
    return `
      <tr>
        <td style="text-align:center;font-weight:600;">${p.installment_number}</td>
        <td>${Utils.formatDate(p.due_date)}</td>
        <td>${Utils.formatCurrency(p.principal_amount)}</td>
        <td>${Utils.formatCurrency(p.interest_amount)}</td>
        <td>${Utils.formatCurrency(p.total_amount)}</td>
        <td><span class="badge" style="color:${st.color};background:${st.bg};">${st.label}</span></td>
        <td>
          ${canPay
            ? `<button class="btn btn-success btn-sm" onclick="openPayModal('${p.id}', ${p.installment_number}, ${p.total_amount})">üí≥ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏≥‡∏£‡∏∞</button>`
            : p.status === 'paid'
              ? `<button class="btn btn-outline btn-sm" onclick="downloadReceiptPDF(${p.installment_number})">üßæ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>`
              : '‚Äì'
          }
        </td>
      </tr>
    `;
  }).join('');
}

// ================================================
// Modal: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏≥‡∏£‡∏∞
// ================================================
function openPayModal(paymentId, installment, dueAmount) {
  document.getElementById('modalPaymentId').value       = paymentId;
  document.getElementById('modalInstallment').textContent = installment;
  document.getElementById('modalDueAmount').value      = Utils.formatCurrency(dueAmount);
  document.getElementById('modalPaidAmount').value     = dueAmount;
  document.getElementById('modalReceiptNumber').value  = '';
  document.getElementById('modalNotes').value          = '';
  document.getElementById('payModal').classList.add('show');
}

function closePayModal() {
  document.getElementById('payModal').classList.remove('show');
}

async function confirmPayment() {
  const paymentId  = document.getElementById('modalPaymentId').value;
  const paidAmount = parseFloat(document.getElementById('modalPaidAmount').value);
  const payMethod  = document.getElementById('modalPayMethod').value;
  const receiptNum = document.getElementById('modalReceiptNumber').value.trim();
  const notes      = document.getElementById('modalNotes').value.trim();

  if (!paidAmount || paidAmount <= 0) {
    Utils.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏à‡πà‡∏≤‡∏¢', 'error');
    return;
  }

  const payment  = currentPayments.find(p => p.id === paymentId);
  const newStatus = paidAmount >= payment.total_amount ? 'paid' : 'partial';

  try {
    await DB.updatePayment(paymentId, {
      paid_amount:    paidAmount,
      paid_date:      new Date().toISOString().split('T')[0],
      payment_method: payMethod,
      receipt_number: receiptNum || `RCP-${Date.now()}`,
      notes,
      status:         newStatus
    });

    closePayModal();
    Utils.showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
    await loadLoanDetail(currentLoan.id);
  } catch (err) {
    Utils.showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
  }
}

// ================================================
// PDF Downloads
// ================================================
function downloadSchedulePDF() {
  PDFGenerator.generatePaymentSchedulePDF(currentLoan, currentPayments);
}
function downloadSummaryPDF() {
  PDFGenerator.generateSummaryPDF(currentLoan, currentPayments, currentSummary);
}
function downloadReceiptPDF(installmentNumber) {
  const payment = currentPayments.find(p => p.installment_number === installmentNumber);
  if (payment) PDFGenerator.generateReceiptPDF(currentLoan, payment);
}
</script>

</body>
</html>
