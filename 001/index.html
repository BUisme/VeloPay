<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î ‚Äì Loan Payment System</title>
  <link rel="stylesheet" href="css/main.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/index.js"></script>
</head>
<body>

<!-- ========== SIDEBAR ========== -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon">üí∞</div>
    <div>
      <div class="logo-text">LoanPay</div>
      <div class="logo-sub">‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</div>
    </div>
  </div>
  <nav class="sidebar-nav">
    <a href="index.html" class="active">
      <span class="nav-icon">üìä</span><span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</span>
    </a>
    <a href="loan-form.html">
      <span class="nav-icon">üìù</span><span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏´‡∏°‡πà</span>
    </a>
    <a href="loan-list.html">
      <span class="nav-icon">üìã</span><span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤</span>
    </a>
  </nav>
</aside>

<!-- ========== MAIN ========== -->
<main class="main-content">

  <!-- Topbar -->
  <div class="topbar">
    <div>
      <h1>üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h1>
      <div class="topbar-subtitle">‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ</div>
    </div>
    <a href="loan-form.html" class="btn btn-primary">Ôºã ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏´‡∏°‡πà</a>
  </div>

  <!-- Summary Cards -->
  <div class="summary-grid">
    <div class="summary-card">
      <div class="icon-wrap" style="background:#dbeafe;">üìÑ</div>
      <div>
        <div class="card-label">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
        <div class="card-value" id="totalLoans">0</div>
        <div class="card-sub">‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ</div>
      </div>
    </div>
    <div class="summary-card">
      <div class="icon-wrap" style="background:#dcfce7;">üíµ</div>
      <div>
        <div class="card-label">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏£‡∏ß‡∏°</div>
        <div class="card-value" id="totalAmount">0 ‡∏ö‡∏≤‡∏ó</div>
        <div class="card-sub">‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
      </div>
    </div>
    <div class="summary-card">
      <div class="icon-wrap" style="background:#f3e8ff;">‚úÖ</div>
      <div>
        <div class="card-label">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÅ‡∏ö‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢</div>
        <div class="card-value" id="activeLoans">0</div>
        <div class="card-sub">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ú‡πà‡∏≠‡∏ô</div>
      </div>
    </div>
    <div class="summary-card">
      <div class="icon-wrap" style="background:#fee2e2;">‚ö†Ô∏è</div>
      <div>
        <div class="card-label">‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>
        <div class="card-value" id="overdueLoans">0</div>
        <div class="card-sub">‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏à‡πà‡∏≤‡∏¢</div>
      </div>
    </div>
  </div>

  <!-- Recent Loans Table -->
  <div class="card">
    <div class="card-header">
      <h3>üìã ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
      <a href="loan-list.html" class="btn btn-outline btn-sm">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí</a>
    </div>
    <div class="card-body">
      <div class="table-wrap">
        <table id="recentLoansTable">
          <thead>
            <tr>
              <th>‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Å‡∏π‡πâ</th>
              <th>‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ</th>
              <th>‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡∏á‡∏ß‡∏î</th>
              <th>‡∏á‡∏ß‡∏î</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="recentLoansBody">
            <tr><td colspan="7" style="text-align:center;color:#94a3b8;padding:30px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</main>

<!-- Scripts -->
<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/calculator.js"></script>
<script src="js/database.js"></script>
<script>
(async () => {
  try {
    const loans = await DB.getAllLoans();

    // Summary stats
    document.getElementById('totalLoans').textContent   = loans.length;
    document.getElementById('activeLoans').textContent  = loans.filter(l => l.status === 'active').length;
    document.getElementById('overdueLoans').textContent = loans.filter(l => l.status === 'overdue').length;
    document.getElementById('totalAmount').textContent  = Utils.formatCurrency(
      loans.reduce((sum, l) => sum + (l.loan_amount || 0), 0)
    );

    // Recent loans (‡πÅ‡∏Ñ‡πà 8 ‡∏≠‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
    const tbody = document.getElementById('recentLoansBody');
    const recent = loans.slice(0, 8);

    if (recent.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#94a3b8;padding:30px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏±‡∏ç‡∏ç‡∏≤</td></tr>';
      return;
    }

    tbody.innerHTML = recent.map(loan => {
      const st = Utils.formatStatus(loan.status);
      return `
        <tr>
          <td><strong style="color:var(--primary)">${loan.contract_number}</strong></td>
          <td>${loan.customer_name}</td>
          <td>${Utils.formatCurrency(loan.loan_amount)}</td>
          <td>${Utils.formatCurrency(loan.monthly_payment)}</td>
          <td>${loan.installments} ‡∏á‡∏ß‡∏î</td>
          <td><span class="badge" style="color:${st.color};background:${st.bg};">${st.label}</span></td>
          <td>
            <a href="loan-detail.html?id=${loan.id}" class="btn btn-outline btn-sm">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a>
          </td>
        </tr>
      `;
    }).join('');

  } catch (err) {
    console.error('Dashboard load error:', err);
    Utils.showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
  }
})();
</script>

</body>
</html>
