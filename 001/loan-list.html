<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ‚Äì Loan Payment System</title>
  <link rel="stylesheet" href="css/main.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/index.js"></script>
  <style>
    .filter-bar {
      display: flex; gap: 14px; align-items: flex-end; flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .filter-bar .form-group { margin: 0; flex: 1; min-width: 180px; }
    .filter-bar .form-group label { font-size: 12px; margin-bottom: 4px; }
    .filter-bar input, .filter-bar select { padding: 9px 12px; font-size: 14px; }
    .no-data { text-align:center; color:#94a3b8; padding:40px 20px; }
  </style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon">üí∞</div>
    <div><div class="logo-text">LoanPay</div><div class="logo-sub">‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</div></div>
  </div>
  <nav class="sidebar-nav">
    <a href="index.html"><span class="nav-icon">üìä</span><span>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</span></a>
    <a href="loan-form.html"><span class="nav-icon">üìù</span><span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÉ‡∏´‡∏°‡πà</span></a>
    <a href="loan-list.html" class="active"><span class="nav-icon">üìã</span><span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤</span></a>
  </nav>
</aside>

<!-- Main -->
<main class="main-content">

  <div class="topbar">
    <div>
      <h1>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤</h1>
      <div class="topbar-subtitle">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
    </div>
    <a href="loan-form.html" class="btn btn-primary">Ôºã ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤</a>
  </div>

  <!-- Filter Bar -->
  <div class="filter-bar">
    <div class="form-group">
      <label>‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤ / ‡∏ä‡∏∑‡πà‡∏≠)</label>
      <input type="text" id="searchInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." oninput="filterLoans()"/>
    </div>
    <div class="form-group" style="flex:0.5;">
      <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
      <select id="statusFilter" onchange="filterLoans()">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="active">‡πÅ‡∏ö‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢</option>
        <option value="completed">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>
        <option value="overdue">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</option>
        <option value="cancelled">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</option>
      </select>
    </div>
    <div class="form-group" style="flex:0.5;">
      <label>‡πÅ‡∏ö‡∏ö‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</label>
      <select id="typeFilter" onchange="filterLoans()">
        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="reducing">‡∏•‡∏î‡∏ï‡πâ‡∏ô‡∏•‡∏î‡∏î‡∏≠‡∏Å</option>
        <option value="flat">‡∏Ñ‡∏á‡∏ó‡∏µ‡πà</option>
      </select>
    </div>
  </div>

  <!-- Table -->
  <div class="card">
    <div class="card-header">
      <h3>üìÑ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="loanCount" style="color:#64748b;font-weight:400;font-size:14px;">(‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶)</span></h3>
    </div>
    <div class="card-body" style="padding:0;">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤</th>
              <th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Å‡∏π‡πâ</th>
              <th>‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ</th>
              <th>‡∏ú‡πà‡∏≠‡∏ô/‡∏á‡∏ß‡∏î</th>
              <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏á‡∏ß‡∏î</th>
              <th>‡πÅ‡∏ö‡∏ö‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</th>
              <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
              <th>‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</th>
            </tr>
          </thead>
          <tbody id="loanListBody">
            <tr><td colspan="9" class="no-data">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</main>

<!-- Scripts -->
<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/calculator.js"></script>
<script src="js/database.js"></script>
<script>
let allLoans = [];

(async () => {
  try {
    allLoans = await DB.getAllLoans();
    renderLoans(allLoans);
  } catch (err) {
    console.error(err);
    Utils.showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
  }
})();

// --- Filter ---
function filterLoans() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const status = document.getElementById('statusFilter').value;
  const type   = document.getElementById('typeFilter').value;

  const filtered = allLoans.filter(l => {
    const matchSearch = !search ||
      l.contract_number.toLowerCase().includes(search) ||
      l.customer_name.toLowerCase().includes(search);
    const matchStatus = !status || l.status === status;
    const matchType   = !type   || l.interest_type === type;
    return matchSearch && matchStatus && matchType;
  });

  renderLoans(filtered);
}

// --- Render Loans ---
function renderLoans(loans) {
  const tbody = document.getElementById('loanListBody');
  document.getElementById('loanCount').textContent = `(${loans.length} ‡∏™‡∏±‡∏ç‡∏ç‡∏≤)`;

  if (loans.length === 0) {
    tbody.innerHTML = '<tr><td colspan="9" class="no-data">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡πÄ‡∏Å‡∏ì‡∏ë‡πå</td></tr>';
    return;
  }

  tbody.innerHTML = loans.map((loan, i) => {
    const st = Utils.formatStatus(loan.status);
    return `
      <tr>
        <td style="color:#94a3b8;">${i + 1}</td>
        <td><strong style="color:var(--primary);">${loan.contract_number}</strong></td>
        <td>${loan.customer_name}</td>
        <td>${Utils.formatCurrency(loan.loan_amount)}</td>
        <td>${Utils.formatCurrency(loan.monthly_payment)}</td>
        <td>${loan.installments} ‡∏á‡∏ß‡∏î</td>
        <td>${Utils.formatInterestType(loan.interest_type)}</td>
        <td><span class="badge" style="color:${st.color};background:${st.bg};">${st.label}</span></td>
        <td>
          <div class="actions">
            <a href="loan-detail.html?id=${loan.id}" class="btn btn-primary btn-sm">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</a>
            <button class="btn btn-outline btn-sm" style="color:var(--danger);border-color:var(--danger);" onclick="deleteLoan('${loan.id}')">‡∏•‡∏ö</button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

// --- Delete Loan ---
async function deleteLoan(id) {
  const ok = await Utils.confirmDialog('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏´‡∏°? (‡∏à‡∏∞‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å)', '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö');
  if (!ok) return;
  try {
    await DB.deleteLoan(id);
    Utils.showToast('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    allLoans = await DB.getAllLoans();
    renderLoans(allLoans);
  } catch (err) {
    Utils.showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message, 'error');
  }
}
</script>

</body>
</html>
