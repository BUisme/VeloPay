<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô ‚Äì Loan Payment System</title>
  <link rel="stylesheet" href="css/main.css"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.1/dist/jspdf.autotable.min.js"></script>
  <style>
    .cust-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .cust-info-item {
      background: var(--gray-50); border-radius: 10px; padding: 14px 16px;
    }
    .cust-info-item .ci-label { font-size:12px; color:var(--gray-500); margin-bottom:3px; }
    .cust-info-item .ci-value { font-size:15px; font-weight:600; color:var(--gray-800); }
    .cust-info-item.highlight { background:var(--primary-100); }
    .cust-info-item.highlight .ci-value { color:var(--primary); font-size:18px; }

    .cust-table-wrap { overflow-x:auto; margin-top:18px; }
    .cust-table-wrap table { font-size:13.5px; }

    .cust-actions { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin-top:22px; }
  </style>
</head>
<body>

<!-- Customer Page (No Sidebar) -->
<div class="customer-page">
  <div class="customer-container">

    <!-- Header -->
    <div class="customer-header">
      <div class="ch-icon">üìä</div>
      <h1>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ú‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞</h1>
      <p>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
    </div>

    <!-- Search Box (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ URL ‡πÑ‡∏°‡πà‡∏°‡∏µ ?contract) -->
    <div class="search-box" id="searchBox">
      <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
      <div class="search-input-wrap">
        <input type="text" id="contractInput" placeholder="‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô LN-2568-12345"
          style="padding:12px 16px;border-radius:10px;border:1px solid var(--gray-300);font-size:15px;font-family:var(--font-main);"/>
        <button class="btn btn-primary" onclick="searchContract()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
      </div>
    </div>

    <!-- Loan Detail Section -->
    <div id="loanDetailSection" style="display:none;">

      <!-- Info -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-header" style="justify-content:space-between;">
          <h3>üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏±‡∏ç‡∏ç‡∏≤</h3>
          <span class="badge" id="custStatus" style="font-size:13px;"></span>
        </div>
        <div class="card-body">
          <div class="cust-info-grid" id="custInfoGrid"></div>
        </div>
      </div>

      <!-- Progress -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-header"><h3>üìà ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞</h3></div>
        <div class="card-body">
          <div style="margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;font-size:13px;color:var(--gray-600);margin-bottom:6px;">
              <span id="custProgressLabel">‡∏à‡πà‡∏≤‡∏¢ 0 / 0 ‡∏á‡∏ß‡∏î</span>
              <span id="custProgressPercent" style="font-weight:700;color:var(--primary);">0%</span>
            </div>
            <div class="progress-wrap"><div class="progress-bar" id="custProgressBar" style="width:0%;"></div></div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:14px;">
            <div style="background:var(--success-bg);border-radius:10px;padding:10px;text-align:center;">
              <div style="font-size:11px;color:var(--success);">‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß</div>
              <div style="font-size:15px;font-weight:700;color:var(--success);" id="custPaid">0</div>
            </div>
            <div style="background:var(--primary-100);border-radius:10px;padding:10px;text-align:center;">
              <div style="font-size:11px;color:var(--primary);">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
              <div style="font-size:15px;font-weight:700;color:var(--primary);" id="custRemaining">0</div>
            </div>
            <div style="background:var(--danger-bg);border-radius:10px;padding:10px;text-align:center;">
              <div style="font-size:11px;color:var(--danger);">‡∏Ñ‡πâ‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>
              <div style="font-size:15px;font-weight:700;color:var(--danger);" id="custOverdue">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment Table -->
      <div class="card" style="margin-bottom:20px;">
        <div class="card-header"><h3>üí≥ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏ß‡∏î</h3></div>
        <div class="card-body" style="padding:0;">
          <div class="cust-table-wrap">
            <table>
              <thead>
                <tr><th>‡∏á‡∏ß‡∏î‡∏ó‡∏µ‡πà</th><th>‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î</th><th>‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πâ‡∏ô</th><th>‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</th><th>‡∏¢‡∏≠‡∏î‡∏à‡πà‡∏≤‡∏¢</th><th>‡∏à‡πà‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á</th><th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th></tr>
              </thead>
              <tbody id="custPaymentBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- PDF Download Buttons -->
      <div class="cust-actions">
        <button class="btn btn-primary" onclick="custDownloadSchedule()">üìë ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ú‡πà‡∏≠‡∏ô</button>
        <button class="btn btn-outline" onclick="custDownloadSummary()">üìä ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
      </div>
    </div>

    <!-- Not Found -->
    <div id="notFoundBox" style="display:none;" class="card">
      <div class="card-body" style="text-align:center;padding:50px 20px;">
        <div style="font-size:48px;margin-bottom:12px;">‚ùå</div>
        <h3 style="color:var(--danger);margin-bottom:8px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ô‡∏µ‡πâ</h3>
        <p style="color:var(--gray-500);font-size:14px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>
        <button class="btn btn-outline btn-sm" style="margin-top:14px;" onclick="resetSearch()">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏´‡∏°‡πà</button>
      </div>
    </div>

  </div>
</div>

<!-- Scripts -->
<script src="js/config.js"></script>
<script src="js/utils.js"></script>
<script src="js/calculator.js"></script>
<script src="js/database.js"></script>
<script src="js/pdf-generator.js"></script>
<script>
let custLoan     = null;
let custPayments = [];
let custSummary  = null;

// Auto-search ‡∏ñ‡πâ‡∏≤ URL ‡∏°‡∏µ ?contract=xxx
(async () => {
  const params   = new URLSearchParams(window.location.search);
  const contract = params.get('contract');
  if (contract) {
    document.getElementById('contractInput').value = contract;
    await searchContract();
  }
})();

// --- Search by Contract Number ---
async function searchContract() {
  const contractNumber = document.getElementById('contractInput').value.trim();
  if (!contractNumber) {
    Utils.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏™‡∏±‡∏ç‡∏ç‡∏≤', 'warning');
    return;
  }

  document.getElementById('loanDetailSection').style.display = 'none';
  document.getElementById('notFoundBox').style.display       = 'none';

  try {
    custLoan     = await DB.getLoanByContractNumber(contractNumber);
    custPayments = await DB.getPaymentsByLoanId(custLoan.id);
    custSummary  = await DB.getPaymentSummary(custLoan.id);

    document.getElementById('searchBox').style.display         = 'none';
    document.getElementById('loanDetailSection').style.display = 'block';

    renderCustomerView();
  } catch (err) {
    document.getElementById('searchBox').style.display  = 'none';
    document.getElementById('notFoundBox').style.display = 'block';
  }
}

function resetSearch() {
  document.getElementById('searchBox').style.display         = 'block';
  document.getElementById('loanDetailSection').style.display = 'none';
  document.getElementById('notFoundBox').style.display       = 'none';
  document.getElementById('contractInput').value             = '';
}

// --- Render Customer View ---
function renderCustomerView() {
  const loan    = custLoan;
  const summary = custSummary;
  const status  = Utils.formatStatus(loan.status);

  // Status badge
  const statusEl = document.getElementById('custStatus');
  statusEl.textContent   = status.label;
  statusEl.style.color   = status.color;
  statusEl.style.background = status.bg;

  // Info Grid
  document.getElementById('custInfoGrid').innerHTML = `
    <div class="cust-info-item highlight">
      <div class="ci-label">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏™‡∏±‡∏ç‡∏ç‡∏≤</div>
      <div class="ci-value">${loan.contract_number}</div>
    </div>
    <div class="cust-info-item">
      <div class="ci-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏Å‡∏π‡πâ</div>
      <div class="ci-value">${loan.customer_name}</div>
    </div>
    <div class="cust-info-item">
      <div class="ci-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡∏π‡πâ</div>
      <div class="ci-value">${Utils.formatCurrency(loan.loan_amount)}</div>
    </div>
    <div class="cust-info-item highlight">
      <div class="ci-label">‡∏ú‡πà‡∏≠‡∏ô‡∏ï‡πà‡∏≠‡∏á‡∏ß‡∏î</div>
      <div class="ci-value">${Utils.formatCurrency(loan.monthly_payment)}</div>
    </div>
    <div class="cust-info-item">
      <div class="ci-label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏î‡∏≠‡∏Å‡πÄ‡∏ö‡∏µ‡πâ‡∏¢</div>
      <div class="ci-value">${loan.interest_rate}% (${Utils.formatInterestType(loan.interest_type)})</div>
    </div>
    <div class="cust-info-item">
      <div class="ci-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡∏ç‡∏ç‡∏≤</div>
      <div class="ci-value">${Utils.formatDate(loan.start_date)}</div>
    </div>
  `;

  // Progress
  document.getElementById('custProgressLabel').textContent  = `‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß ${summary.paidCount} / ${summary.totalInstallments} ‡∏á‡∏ß‡∏î`;
  document.getElementById('custProgressPercent').textContent = `${summary.progressPercent}%`;
  document.getElementById('custProgressBar').style.width    = `${summary.progressPercent}%`;
  document.getElementById('custPaid').textContent           = Utils.formatCurrency(summary.totalPaid);
  document.getElementById('custRemaining').textContent      = Utils.formatCurrency(summary.remainingAmount);
  document.getElementById('custOverdue').textContent        = `${summary.overdueCount} ‡∏á‡∏ß‡∏î`;

  // Payment Table
  document.getElementById('custPaymentBody').innerHTML = custPayments.map(p => {
    const st = Utils.formatStatus(p.status);
    return `
      <tr>
        <td style="text-align:center;font-weight:600;">${p.installment_number}</td>
        <td>${Utils.formatDate(p.due_date)}</td>
        <td>${Utils.formatCurrency(p.principal_amount)}</td>
        <td>${Utils.formatCurrency(p.interest_amount)}</td>
        <td>${Utils.formatCurrency(p.total_amount)}</td>
        <td>${p.paid_amount ? Utils.formatCurrency(p.paid_amount) : '‚Äì'}</td>
        <td><span class="badge" style="color:${st.color};background:${st.bg};">${st.label}</span></td>
      </tr>
    `;
  }).join('');
}

// --- PDF ---
function custDownloadSchedule() {
  if (custLoan && custPayments.length)
    PDFGenerator.generatePaymentSchedulePDF(custLoan, custPayments);
}
function custDownloadSummary() {
  if (custLoan && custPayments.length && custSummary)
    PDFGenerator.generateSummaryPDF(custLoan, custPayments, custSummary);
}
</script>

</body>
</html>
